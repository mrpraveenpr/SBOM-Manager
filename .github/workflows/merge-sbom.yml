name: Merge SBOM Files

on:
  push:
    branches:
      - "release-*"
    paths:
      - "sbom-source.json"
      - "sbom-docker.json"

jobs:
  merge-sbom:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout with PAT
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SBOM_MANAGER_TOKEN }}

      - name: Merge SBOM Files Properly (Docker)
        run: |
          echo "ðŸ”„ Starting proper SBOM merge using Docker CLI..."

          docker run --rm \
            -v "$(pwd)":/data \
            cyclonedx/cyclonedx-cli:latest \
            merge \
              --input-files /data/sbom-source.json \
              --input-files /data/sbom-docker.json \
              --output-file /data/merged-sbom.json

          echo "âœ… Merged SBOM created:"
          cat merged-sbom.json

      - name: Commit & Push merged SBOM
        run: |
          BRANCH="${{ github.ref_name }}"

          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          git add merged-sbom.json
          git commit -m "Add merged SBOM for branch $BRANCH [skip ci]" || true

          echo "ðŸ”¼ Pushing merged SBOM back to branch $BRANCH"
          git push "https://${{ secrets.SBOM_MANAGER_USERNAME }}:${{ secrets.SBOM_MANAGER_TOKEN }}@github.com/${{ secrets.SBOM_MANAGER_REPO }}.git" "$BRANCH"
