name: Merge SBOM Files

on:
  push:
    branches:
      - "release-*"
    paths:
      - "sbom-source.json"
      - "sbom-docker.json"

jobs:
  merge-sbom:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      # Checkout Repository
      # ---------------------------------------------------------
      - name: Checkout Repository (using PAT)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SBOM_MANAGER_TOKEN }}

      # ---------------------------------------------------------
      # 1. Merge CycloneDX SBOM Files
      # ---------------------------------------------------------
      - name: Merge SBOM Files (CycloneDX CLI via Docker)
        run: |
          echo "Starting SBOM merge using CycloneDX CLI..."

          docker run --rm \
            -v "$(pwd)":/data \
            cyclonedx/cyclonedx-cli:latest \
            merge \
              --input-files /data/sbom-source.json \
              --input-files /data/sbom-docker.json \
              --output-file /data/merged-sbom.json

          echo "Merged SBOM created:"
          cat merged-sbom.json

      # ---------------------------------------------------------
      # 2. Commit and Push Merged SBOM
      # ---------------------------------------------------------
      - name: Commit and Push Merged SBOM
        run: |
          BRANCH="${{ github.ref_name }}"

          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          git add merged-sbom.json
          git commit -m "Add merged SBOM for branch $BRANCH [skip ci]" || true

          echo "Pushing merged SBOM to branch $BRANCH"
          git push \
            "https://${{ secrets.SBOM_MANAGER_USERNAME }}:${{ secrets.SBOM_MANAGER_TOKEN }}@github.com/${{ secrets.SBOM_MANAGER_REPO }}.git" \
            "$BRANCH"

      # ---------------------------------------------------------
      # 3. Convert CycloneDX â†’ FOSSA-Compatible Format
      # ---------------------------------------------------------
      - name: Convert CycloneDX SBOM to FOSSA Format (fossa-deps.json)
        run: |
          echo "Converting merged-sbom.json to FOSSA dependency format"
          npm install -g @cyclonedx/cdxgen

          cdxgen --make-fossa-deps merged-sbom.json -o fossa-deps.json

          echo "Converted SBOM:"
          cat fossa-deps.json

      # ---------------------------------------------------------
      # 4. Install FOSSA CLI v3
      # ---------------------------------------------------------
      - name: Install FOSSA CLI v3
        run: |
          curl -H "Cache-Control: no-cache" \
            https://raw.githubusercontent.com/fossas/fossa-cli/master/install-latest.sh | bash

          echo "$HOME/.fossa/bin" >> "$GITHUB_PATH"

      # ---------------------------------------------------------
      # 5. Upload SBOM to FOSSA
      # ---------------------------------------------------------
      - name: Upload SBOM to FOSSA
        env:
          FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
        run: |
          BRANCH="${{ github.ref_name }}"

          echo "Uploading fossa-deps.json to FOSSA for revision $BRANCH"
          fossa analyze \
            --fossa-deps-file fossa-deps.json \
            --revision "$BRANCH"

          echo "FOSSA import complete"
