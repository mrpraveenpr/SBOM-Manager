name: Merge SBOM Files

on:
  push:
    branches:
      - "release-*"
    paths:
      - "sbom-source.json"
      - "sbom-docker.json"

jobs:
  merge-sbom:
    runs-on: ubuntu-latest

    env:
      PROJECT_LOCATOR_ENC: "sbom%2B58434/Origin%20Medical"
      PROJECT_NAME: "Origin Medical"
      FOSSA_BASE: "https://app.fossa.com/api"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SBOM_MANAGER_TOKEN }}

      - name: Merge SBOM Files (CycloneDX CLI via Docker)
        run: |
          docker run --rm \
            -v "$(pwd)":/data \
            cyclonedx/cyclonedx-cli:latest \
            merge \
              --input-files /data/sbom-source.json \
              --input-files /data/sbom-docker.json \
              --output-file /data/merged-sbom.json

      - name: Commit and Push Merged SBOM
        run: |
          BRANCH="${{ github.ref_name }}"
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add merged-sbom.json
          git commit -m "Add merged SBOM for branch $BRANCH [skip ci]" || true
          git push \
            "https://${{ secrets.SBOM_MANAGER_USERNAME }}:${{ secrets.SBOM_MANAGER_TOKEN }}@github.com/${{ secrets.SBOM_MANAGER_REPO }}.git" \
            "$BRANCH"

      - name: Install FOSSA CLI v3
        run: |
          curl -H "Cache-Control: no-cache" \
            https://raw.githubusercontent.com/fossas/fossa-cli/master/install-latest.sh | bash
          echo "$HOME/.fossa/bin" >> "$GITHUB_PATH"

      - name: Upload merged SBOM to FOSSA
        env:
          FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
        run: |
          BRANCH="${{ github.ref_name }}"
          echo "Uploading SBOM to FOSSA project: $PROJECT_NAME"

          fossa sbom analyze merged-sbom.json \
            --project "$PROJECT_NAME" \
            --revision "$BRANCH"

      # -------------------------------------------------------------
      #  CREATE PROJECT RELEASE (SUPPORTED)
      # -------------------------------------------------------------
      - name: Create FOSSA Project Release
        env:
          FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
        run: |
          BRANCH="${{ github.ref_name }}"
          RELEASE_TITLE="${BRANCH}-$(date +%Y%m%d-%H%M%S)"

          echo "Creating Project Release: $RELEASE_TITLE"

          RESPONSE=$(curl -s -X POST "$FOSSA_BASE/projects/$PROJECT_LOCATOR_ENC/releases" \
            -H "Authorization: token $FOSSA_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
                  \"title\": \"$RELEASE_TITLE\",
                  \"revision\": \"$BRANCH\",
                  \"branch\": \"master\"
                }")

          echo "API Response: $RESPONSE"

          RELEASE_ID=$(echo "$RESPONSE" | jq -r '.id')

          if [ "$RELEASE_ID" = "null" ] || [ -z "$RELEASE_ID" ]; then
            echo "Failed to create release!"
            exit 1
          fi

          echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_ENV
          echo "Created Project Release ID: $RELEASE_ID"

      # -------------------------------------------------------------
      #  START BUILD FOR PROJECT RELEASE
      # -------------------------------------------------------------
      - name: Start FOSSA Build
        env:
          FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
          RELEASE_ID: ${{ env.RELEASE_ID }}
        run: |
          echo "Starting build for release $RELEASE_ID"

          RESPONSE=$(curl -s -X POST "$FOSSA_BASE/releases/$RELEASE_ID/builds" \
            -H "Authorization: token $FOSSA_API_KEY" \
            -H "Content-Type: application/json")

          echo "Build Start Response: $RESPONSE"

          BUILD_ID=$(echo "$RESPONSE" | jq -r '.id')

          if [ "$BUILD_ID" = "null" ] || [ -z "$BUILD_ID" ]; then
            echo "Failed to start build!"
            exit 1
          fi

          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "Build ID: $BUILD_ID"

      # -------------------------------------------------------------
      #  WAIT FOR BUILD COMPLETION
      # -------------------------------------------------------------
      - name: Wait for FOSSA Build to Complete
        env:
          FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
          BUILD_ID: ${{ env.BUILD_ID }}
        run: |
          echo "Waiting for build $BUILD_ID to finish..."

          while true; do
            STATUS=$(curl -s "$FOSSA_BASE/builds/$BUILD_ID" \
              -H "Authorization: token $FOSSA_API_KEY" | jq -r '.status')

            echo "Build Status: $STATUS"

            if [ "$STATUS" = "COMPLETE" ]; then
              echo "Build completed!"
              break
            fi

            if [ "$STATUS" = "FAILED" ]; then
              echo "Build failed!"
              exit 1
            fi

            sleep 10
          done

      # -------------------------------------------------------------
      #  DOWNLOAD PROJECT PDF REPORT
      # -------------------------------------------------------------
      - name: Download FOSSA Project PDF Report
        env:
          FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
          RELEASE_ID: ${{ env.RELEASE_ID }}
        run: |
          echo "Downloading PDF report for release $RELEASE_ID"

          curl -L \
            -H "Authorization: token $FOSSA_API_KEY" \
            "$FOSSA_BASE/releases/$RELEASE_ID/report?format=pdf" \
            -o report.pdf

          echo "PDF saved as report.pdf"
