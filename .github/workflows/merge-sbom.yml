name: Merge SBOM Files

on:
  push:
    branches:
      - "release-*"
    paths:
      - "sbom-source.json"
      - "sbom-docker.json"

jobs:
  merge-sbom:
    runs-on: ubuntu-latest

    env:
      PROJECT_LOCATOR_ENC: "sbom%2B58434/Origin%20Medical"
      RELEASE_GROUP_NAME: "demo-group"
      PROJECT_NAME: "Origin Medical"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SBOM_MANAGER_TOKEN }}

      - name: Merge SBOM Files (CycloneDX CLI via Docker)
        run: |
          docker run --rm \
            -v "$(pwd)":/data \
            cyclonedx/cyclonedx-cli:latest \
            merge \
              --input-files /data/sbom-source.json \
              --input-files /data/sbom-docker.json \
              --output-file /data/merged-sbom.json

      - name: Commit and Push Merged SBOM
        run: |
          BRANCH="${{ github.ref_name }}"
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add merged-sbom.json
          git commit -m "Add merged SBOM for branch $BRANCH [skip ci]" || true
          git push \
            "https://${{ secrets.SBOM_MANAGER_USERNAME }}:${{ secrets.SBOM_MANAGER_TOKEN }}@github.com/${{ secrets.SBOM_MANAGER_REPO }}.git" \
            "$BRANCH"

      - name: Install FOSSA CLI v3
        run: |
          curl -H "Cache-Control: no-cache" \
            https://raw.githubusercontent.com/fossas/fossa-cli/master/install-latest.sh | bash
          echo "$HOME/.fossa/bin" >> "$GITHUB_PATH"

      - name: Upload merged SBOM to FOSSA
        env:
          FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
        run: |
          BRANCH="${{ github.ref_name }}"
          echo "Uploading SBOM to FOSSA project: $PROJECT_NAME"
          fossa sbom analyze merged-sbom.json \
            --project "$PROJECT_NAME" \
            --revision "$BRANCH"

      - name: Create New FOSSA Release (corrected flags)
        env:
          FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
        run: |
          RELEASE_TITLE="${{ github.ref_name }}-$(date +'%Y%m%d-%H%M%S')"

          echo "Creating new FOSSA Release: $RELEASE_TITLE"
          echo "Release Group
