name: Merge SBOM Files

on:
  push:
    branches:
      - "release-*"
      - "feat/*"
    paths:
      - "sbom-source.json"
      - "sbom-docker.json"
  pull_request:
    branches:
      - main
      - develop
      - "release-*"
      - "feat/*"
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to run SBOM processing on"
        required: false
        default: ""
      force:
        description: "Force run even if no SBOM files changed"
        type: boolean
        required: false
        default: false
jobs:
  merge-sbom:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      # Checkout Repository
      # ---------------------------------------------------------
      - name: Checkout Repository (using PAT)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SBOM_MANAGER_TOKEN }}

      # ---------------------------------------------------------
      # 1. Merge CycloneDX SBOM Files
      # ---------------------------------------------------------
      - name: Merge SBOM Files (CycloneDX CLI via Docker)
        run: |
          echo "Starting SBOM merge using CycloneDX CLI..."

          docker run --rm \
            -v "$(pwd)":/data \
            cyclonedx/cyclonedx-cli:latest \
            merge \
              --input-files /data/sbom-source.json \
              --input-files /data/sbom-docker.json \
              --output-file /data/merged-sbom.json

          echo "Merged SBOM created:"
          cat merged-sbom.json

      # ---------------------------------------------------------
      # 2. Commit and Push Merged SBOM
      # ---------------------------------------------------------
      - name: Commit and Push Merged SBOM
        run: |
          BRANCH="${{ github.ref_name }}"

          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          git add merged-sbom.json
          git commit -m "Add merged SBOM for branch $BRANCH [skip ci]" || true

          echo "Pushing merged SBOM to branch $BRANCH"
          git push \
            "https://${{ secrets.SBOM_MANAGER_USERNAME }}:${{ secrets.SBOM_MANAGER_TOKEN }}@github.com/${{ secrets.SBOM_MANAGER_REPO }}.git" \
            "$BRANCH"

      # ---------------------------------------------------------
      # 3. Install FOSSA CLI v3
      # ---------------------------------------------------------
      - name: Install FOSSA CLI v3
        run: |
          curl -H "Cache-Control: no-cache" \
            https://raw.githubusercontent.com/fossas/fossa-cli/master/install-latest.sh | bash
          echo "$HOME/.fossa/bin" >> "$GITHUB_PATH"

      # ---------------------------------------------------------
      # 4. Upload merged SBOM to FOSSA (project: Origin Medical)
      # ---------------------------------------------------------
      - name: Upload merged SBOM to FOSSA
        env:
          FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
        run: |
          BRANCH="${{ github.ref_name }}"

          echo "Uploading merged-sbom.json to FOSSA project 'Origin Medical', revision $BRANCH"

          fossa sbom analyze merged-sbom.json \
            --project "Origin Medical" \
            --revision "$BRANCH"

          echo "FOSSA import complete"

          # ---------------------------------------------------------
          
      # 5. Create or Update FOSSA Release in Release Group
      # ---------------------------------------------------------
      - name: Create FOSSA Release (Release Group)
        id: create_release
        env:
          FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
          RELEASE_GROUP_ID: ${{ secrets.FOSSA_RELEASE_GROUP_ID }}
        run: |
          REVISION="${{ github.ref_name }}"

          echo "Creating release for revision $REVISION"

          BODY="{\"revision\": \"$REVISION\"}"

          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $FOSSA_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$BODY" \
            "https://app.fossa.com/api/project_group/$RELEASE_GROUP_ID/release")

          echo "$RESPONSE"
          
          RELEASE_ID=$(echo "$RESPONSE" | jq -r '.id')
          echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT

