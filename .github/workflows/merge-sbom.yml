name: Merge SBOM Files

on:
  push:
    branches:
      - "release-*"
    paths:
      - "sbom-source.json"
      - "sbom-docker.json"

jobs:
  merge-sbom:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout with PAT
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SBOM_MANAGER_TOKEN }}

      # Install the official CycloneDX Toolkit (NOT cdxgen merge)
      - name: Install CycloneDX CLI
        run: |
          npm install -g @cyclonedx/cyclonedx-cli

      - name: Merge SBOM Files Properly
        run: |
          echo "ðŸ”„ Starting proper SBOM merge..."

          cyclonedx merge \
            --input-files sbom-source.json sbom-docker.json \
            --output-file merged-sbom.json

          echo "âœ… PROPER merged SBOM generated:"
          cat merged-sbom.json

      - name: Commit & Push merged SBOM
        run: |
          BRANCH="${{ github.ref_name }}"

          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          git add merged-sbom.json
          git commit -m "Add merged SBOM for branch $BRANCH [skip ci]" || true

          git push https://${{ secrets.SBOM_MANAGER_USERNAME }}:${{ secrets.SBOM_MANAGER_TOKEN }}@github.com/${{ secrets.SBOM_MANAGER_REPO }} "$BRANCH"
