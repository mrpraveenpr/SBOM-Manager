name: Merge SBOM Files

on:
  push:
    branches:
      - "release-*"
    paths:
      - "sbom-source.json"
      - "sbom-docker.json"

jobs:
  merge-sbom:
    runs-on: ubuntu-latest

    env:
      PROJECT_LOCATOR_ENC: "sbom%2B58434%2FOrigin%20Medical"   # CORRECT
      PROJECT_LOCATOR_DEC: "sbom+58434/Origin Medical"         # CORRECT
      PROJECT_NAME: "Origin Medical"
      FOSSA_BASE: "https://app.fossa.com/api"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SBOM_MANAGER_TOKEN }}

      - name: Merge SBOM Files (CycloneDX CLI via Docker)
        run: |
          docker run --rm \
            -v "$(pwd)":/data \
            cyclonedx/cyclonedx-cli:latest \
            merge \
              --input-files /data/sbom-source.json \
              --input-files /data/sbom-docker.json \
              --output-file /data/merged-sbom.json

      - name: Commit and Push Merged SBOM
        run: |
          BRANCH="${{ github.ref_name }}"
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add merged-sbom.json
          git commit -m "Add merged SBOM for branch $BRANCH [skip ci]" || true
          git push \
            "https://${{ secrets.SBOM_MANAGER_USERNAME }}:${{ secrets.SBOM_MANAGER_TOKEN }}@github.com/${{ secrets.SBOM_MANAGER_REPO }}.git" \
            "$BRANCH"

      - name: Install FOSSA CLI v3
        run: |
          curl -H "Cache-Control: no-cache" \
            https://raw.githubusercontent.com/fossas/fossa-cli/master/install-latest.sh | bash
          echo "$HOME/.fossa/bin" >> "$GITHUB_PATH"

      - name: Upload merged SBOM to FOSSA
        env:
          FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
        run: |
          BRANCH="${{ github.ref_name }}"
          echo "Uploading SBOM to FOSSA project: $PROJECT_NAME"

          fossa sbom analyze merged-sbom.json \
            --project "$PROJECT_LOCATOR_DEC" \
            --revision "$BRANCH"

      # -------------------------------------------------------------
      # CREATE PROJECT RELEASE (SUPPORTED)
      # -------------------------------------------------------------
      - name: Create FOSSA Project Release
        env:
          FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
        run: |
          BRANCH="${{ github.ref_name }}"
          RELEASE_TITLE="${BRANCH}-$(date +%Y%m%d-%H%M%S)"

          echo "Creating Project Release: $RELEASE_TITLE"

          RESPONSE=$(curl -s -X POST "$FOSSA_BASE/projects/$PROJECT_LOCATOR_ENC/releases" \
            -H "Authorization: token $FOSSA_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
                  \"title\": \"$RELEASE_TITLE\",
                  \"revision\": \"$BRANCH\",
                  \"branch\": \"master\"
                }")

          echo "API Response: $RESPONSE"

          RELEASE_ID=$(echo "$RESPONSE" | jq -r '.id')

          if [ "$RELEASE_ID" = "null" ] || [ -z "$RELEASE_ID" ]; then
            echo "Failed to create release!"
            exit 1
          fi

          echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_ENV
          echo "Created Project Release ID: $RELEASE_ID"

      # -------------------------------------------------------------
      # START BUILD
      # -------------------------------------------------------------
      - name: Start FOSSA Build
        env:
          FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
          RELEASE_ID: ${{ env.RELEASE_ID }}
        run: |
          echo "Starting build for release $RELEASE_ID"

          RESPONSE=$(curl -s -X POST "$FOSSA_BASE/releases/$RELEASE_
