name: üîÑ Merge All Latest SBOMs & Upload to FOSSA (OMEA)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"  # üïë Run daily at 02:00 UTC

jobs:
  merge-upload:
    runs-on: ubuntu-latest
    env:
      FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
      FOSSA_PROJECT_NAME: "OMEA"
      FOSSA_TELEMETRY_SCOPE: off
      PUSH_TOKEN: ${{ secrets.SBOM_PUSH_TOKEN }}

    steps:
      # -----------------------------------------------------------
      # 1Ô∏è‚É£ Checkout repo (disable default GitHub token)
      # -----------------------------------------------------------
      - name: üß© Checkout SBOM Manager Repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # prevent use of default GITHUB_TOKEN

      # -----------------------------------------------------------
      # 2Ô∏è‚É£ Install CycloneDX CLI & FOSSA CLI
      # -----------------------------------------------------------
      - name: üîß Install CycloneDX CLI & FOSSA CLI
        run: |
          sudo apt-get update -y && sudo apt-get install -y jq
          echo "üì¶ Installing CycloneDX CLI..."
          wget -q https://github.com/CycloneDX/cyclonedx-cli/releases/latest/download/cyclonedx-linux-x64
          chmod +x cyclonedx-linux-x64
          sudo mv cyclonedx-linux-x64 /usr/local/bin/cyclonedx
          echo "‚úÖ CycloneDX version: $(cyclonedx --version)"
          echo "üì¶ Installing FOSSA CLI..."
          curl -sSL -o /tmp/fossa.tar.gz https://github.com/fossas/fossa-cli/releases/download/v3.12.1/fossa_3.12.1_linux_amd64.tar.gz
          tar -xzf /tmp/fossa.tar.gz -C /tmp
          sudo mv /tmp/fossa /usr/local/bin/fossa
          echo "‚úÖ FOSSA version: $(fossa --version)"

      # -----------------------------------------------------------
      # 3Ô∏è‚É£ Collect and merge all latest SBOMs
      # -----------------------------------------------------------
      - name: üîÅ Merge all latest SBOMs into a single file
        run: |
          set -euo pipefail
          BASE_DIR="sboms"
          MERGED_FILE="$BASE_DIR/complete-merged-sbom.cdx.json"
          TEMP_LIST="/tmp/sbom-list.txt"

          echo "üîç Collecting all latest SBOMs (excluding old/ and merged files)..."
          rm -f "$TEMP_LIST"
          find "$BASE_DIR" -type f -name "*.cdx.json" \
            ! -path "*/old/*" \
            ! -name "merged-sbom.cdx.json" \
            ! -name "complete-merged-sbom.cdx.json" > "$TEMP_LIST"

          if [ ! -s "$TEMP_LIST" ]; then
            echo "‚ö†Ô∏è No SBOMs found to merge."
            exit 0
          fi

          echo "üß© Merging $(wc -l < $TEMP_LIST) SBOM(s) into a single complete SBOM..."
          cyclonedx merge --input-files $(cat "$TEMP_LIST") --output-file "$MERGED_FILE"
          echo "‚úÖ Created unified SBOM ‚Üí $MERGED_FILE"

      # -----------------------------------------------------------
      # 4Ô∏è‚É£ Commit and Push merged SBOM (using Personal Access Token)
      # -----------------------------------------------------------
      - name: üíæ Commit and Push merged SBOM
        if: env.PUSH_TOKEN != ''
        run: |
          set -e

          echo "üíæ Configuring Git..."
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

          echo "üì¶ Preparing commit..."
          git add sboms/complete-merged-sbom.cdx.json
          git commit -m "üß© Complete merged SBOM generated - $(date -u '+%Y-%m-%d %H:%M:%S')" || echo "‚ÑπÔ∏è No new changes to commit"

          echo "üîê Reconfiguring authenticated remote..."
          git remote remove origin || true
          git remote add origin https://x-access-token:${PUSH_TOKEN}@github.com/mrpraveenpr/SBOM-Manager.git

          echo "üöÄ Pushing changes to main branch..."
          git push origin main || (echo "‚ùå Push failed"; exit 1)

          echo "‚úÖ Complete merged SBOM committed & pushed successfully."

      # -----------------------------------------------------------
      # 5Ô∏è‚É£ Upload unified SBOM to FOSSA (OMEA)
      # -----------------------------------------------------------
      - name: ‚òÅÔ∏è Upload unified SBOM to FOSSA (OMEA)
        if: env.FOSSA_API_KEY != ''
        run: |
          set -euo pipefail
          MERGED_FILE="sboms/complete-merged-sbom.cdx.json"

          if [ -f "$MERGED_FILE" ]; then
            echo "üöÄ Uploading unified SBOM to FOSSA project: ${FOSSA_PROJECT_NAME}..."
            fossa sbom analyze \
              --fossa-api-key "${FOSSA_API_KEY}" \
              --project "${FOSSA_PROJECT_NAME}" \
              --force-rescan \
              "$MERGED_FILE"
            echo "‚úÖ Successfully uploaded complete merged SBOM to ${FOSSA_PROJECT_NAME}"
          else
            echo "‚ö†Ô∏è No unified SBOM found to upload."
          fi

      # -----------------------------------------------------------
      # 6Ô∏è‚É£ Skip upload if missing tokens
      # -----------------------------------------------------------
      - name: ‚ö†Ô∏è Skip steps if tokens missing
        if: env.FOSSA_API_KEY == '' || env.PUSH_TOKEN == ''
        run: echo "‚ö†Ô∏è Missing token(s): ensure SBOM_PUSH_TOKEN and FOSSA_API_KEY are set in repo secrets."
